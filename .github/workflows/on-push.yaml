name: '▷️ Test [development]'

on:
  push:
  workflow_dispatch:
    inputs:
      SOME_CHOICE:
        type: choice
        options:
          - development
          - production
      ENV_VARIABLE:
      OTHER_ENV_VARIABLE:

env:
  IS_MASTER: ${{ github.ref_name == github.event.repository.default_branch }}
  IS_NOT_MASTER: ${{ github.ref_name != github.event.repository.default_branch }}

jobs:

  matrix-template-job:
    uses: ./.github/workflows/matrix-template-with-inherited-secrets.yaml
    with:
      FILTERS: |
        [
          "filter1",
          "filter2",
        ]
    secrets: inherit

  matrix-job:
    strategy:
      max-parallel: 1
      matrix:
        MATRIX_VALUE:
          - value-1
    runs-on: ubuntu-latest
    steps:
      - name: Echo matrix
        run: sleep 2 && echo 'MATRIX_VALUE is ${{ matrix.MATRIX_VALUE }}'

  junit-report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - uses: mikepenz/action-junit-report@v3
        if: always() # always run even if the previous step fails
        with:
          report_paths: './test-results/test/TEST-*.xml'
          check_name: '⚠️ ${{ github.run_id }} Test Report ⚠️'
          summary: |
            ### Keep it up! 🏆💪
            #### Useful links
            - Qase Report ► https://example.com/
            - Slack channel ► [#channel-name](https://example.com/)
          fail_on_failure: true
          include_passed: true
          require_tests: true

  run-some-job:
    runs-on: ubuntu-latest
    steps:
      - name: Echo
        run: |
          echo '${{ toJSON(github) }}'
          echo "[DIRECT_JOB] ${{ env.ENV_VARIABLE }}"
          echo "[DIRECT_JOB] ${{ env.OTHER_ENV_VARIABLE }}"
          echo "[DIRECT_JOB] ${{ secrets.SUPER_SECRET }}"
          echo '### Nice work *${{ github.actor }}*! :rocket:' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo 'You just executed ${{ github.workflow }}' >> $GITHUB_STEP_SUMMARY
          [[ $IS_MASTER = true ]] && isMaster="a **default** branch" || a="not a **default** branch"
          echo "on ${{ github.ref_name }} branch which is $isMaster" >> $GITHUB_STEP_SUMMARY
      - name: Adding markdown
        run: echo '### 2. Hello world! :rocket:' >> $GITHUB_STEP_SUMMARY

  run-template:
    uses: ./.github/workflows/template.yaml
    if: ${{ inputs.SOME_CHOICE == 'development' || false }}
    with:
      ENV_VARIABLE: ${{ inputs.ENV_VARIABLE || 'default-ENV_VARIABLE' }}
      OTHER_ENV_VARIABLE: ${{ inputs.OTHER_ENV_VARIABLE || 'default-OTHER_ENV_VARIABLE' }}
    secrets:
      ALL_SECRETS: '${{ toJSON(secrets) }}'

  run-template-inherited:
    uses: ./.github/workflows/template-with-inherited-secrets.yaml
    if: ${{ inputs.SOME_CHOICE == 'development' || true }}
    with:
      ENV_VARIABLE: ${{ inputs.ENV_VARIABLE || 'default-ENV_VARIABLE' }}
      OTHER_ENV_VARIABLE: ${{ inputs.OTHER_ENV_VARIABLE || 'default-OTHER_ENV_VARIABLE' }}
    secrets: inherit